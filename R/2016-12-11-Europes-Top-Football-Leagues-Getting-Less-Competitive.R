# football team crests used in the network graphs

crests=data.frame(team=c("Arsenal","Aston Villa","Barnsley","Birmingham","Birmingham City",
                         "Blackburn","Blackpool","Bolton","Bournemouth","Bradford","Burnley",
                         "Cardiff","Charlton","Chelsea","Coventry","Crystal Palace","Derby",
                         "Everton","Fulham","Hull","Ipswich","Leeds","Leicester","Liverpool",
                         "Man City","Man United","Middlesboro","Middlesbrough","Newcastle",
                         "Norwich","Nott'm Forest","Portsmouth","QPR","Reading","Sheffield Weds",
                         "Sheffield United","Southampton","Stoke","Sunderland","Swansea","Tottenham",
                         "Watford","West Brom","West Ham","Wigan","Wimbledon","Wolves"),
                  image= c("http://upload.wikimedia.org/wikipedia/en/5/53/Arsenal_FC.svg",
                           "http://upload.wikimedia.org/wikipedia/de/9/9f/Aston_Villa_logo.svg",
                           "https://upload.wikimedia.org/wikipedia/en/c/c9/Barnsley_FC.svg",
                           "https://upload.wikimedia.org/wikipedia/en/6/68/Birmingham_City_FC_logo.svg",
                           "https://upload.wikimedia.org/wikipedia/en/6/68/Birmingham_City_FC_logo.svg",
                           "https://upload.wikimedia.org/wikipedia/en/0/0f/Blackburn_Rovers.svg",
                           "https://upload.wikimedia.org/wikipedia/en/d/df/Blackpool_FC_logo.svg",
                           "https://upload.wikimedia.org/wikipedia/en/8/82/Bolton_Wanderers_FC_logo.svg",
                           "https://upload.wikimedia.org/wikipedia/de/4/41/Afc_bournemouth.svg",
                           "https://upload.wikimedia.org/wikipedia/en/3/32/Bradford_City_AFC.png",
                           "https://upload.wikimedia.org/wikipedia/en/0/02/Burnley_FC_badge.png",
                           "http://upload.wikimedia.org/wikipedia/de/c/c6/Cardiff_City_Logo.png",
                           "https://upload.wikimedia.org/wikipedia/en/5/5b/Charlton_Athletic.svg",
                           "http://upload.wikimedia.org/wikipedia/de/5/5c/Chelsea_crest.svg",
                           "https://upload.wikimedia.org/wikipedia/en/9/94/Coventry_City_FC_logo.svg",
                           "http://upload.wikimedia.org/wikipedia/de/b/bf/Crystal_Palace_F.C._logo_(2013).png",
                           "https://upload.wikimedia.org/wikipedia/en/4/4a/Derby_County_crest.svg",
                           "http://upload.wikimedia.org/wikipedia/de/f/f9/Everton_FC.svg",
                           "http://upload.wikimedia.org/wikipedia/de/a/a8/Fulham_fc.svg",
                           "https://upload.wikimedia.org/wikipedia/en/2/20/Hull_City_Crest_2014.svg",
                           "https://upload.wikimedia.org/wikipedia/en/4/43/Ipswich_Town.svg",
                           "https://upload.wikimedia.org/wikipedia/en/0/05/Leeds_United_Logo.png",
                           "http://upload.wikimedia.org/wikipedia/en/6/63/Leicester02.png",
                           "http://upload.wikimedia.org/wikipedia/de/0/0a/FC_Liverpool.svg",
                           "https://upload.wikimedia.org/wikipedia/en/e/eb/Manchester_City_FC_badge.svg",
                           "http://upload.wikimedia.org/wikipedia/de/d/da/Manchester_United_FC.svg",
                           "https://upload.wikimedia.org/wikipedia/en/2/2c/Middlesbrough_FC_crest.svg",
                           "https://upload.wikimedia.org/wikipedia/en/2/2c/Middlesbrough_FC_crest.svg",
                           "http://upload.wikimedia.org/wikipedia/de/5/56/Newcastle_United_Logo.svg",
                           "http://upload.wikimedia.org/wikipedia/de/8/8c/Norwich_City.svg",
                           "https://upload.wikimedia.org/wikipedia/en/d/d2/Nottingham_Forest_logo.svg",
                           "https://upload.wikimedia.org/wikipedia/en/e/e1/Portsmouth_FC_crest_2008.png",
                           "http://upload.wikimedia.org/wikipedia/de/d/d4/Queens_Park_Rangers.svg",
                           "https://upload.wikimedia.org/wikipedia/en/1/11/Reading_FC.svg",
                           "https://upload.wikimedia.org/wikipedia/en/8/86/Sheffield_Wednesday_crest_from_2016.jpg",
                           "https://upload.wikimedia.org/wikipedia/en/9/9c/Sheffield_United_FC_logo.svg",
                           "http://upload.wikimedia.org/wikipedia/de/c/c9/FC_Southampton.svg",
                           "http://upload.wikimedia.org/wikipedia/de/a/a3/Stoke_City.svg",
                           "http://upload.wikimedia.org/wikipedia/de/6/60/AFC_Sunderland.svg",
                           "http://upload.wikimedia.org/wikipedia/de/a/ab/Swansea_City_Logo.svg",
                           "http://upload.wikimedia.org/wikipedia/de/b/b4/Tottenham_Hotspur.svg",
                           "https://upload.wikimedia.org/wikipedia/en/e/e2/Watford.svg",
                           "http://upload.wikimedia.org/wikipedia/de/8/8b/West_Bromwich_Albion.svg",
                           "http://upload.wikimedia.org/wikipedia/de/e/e0/West_Ham_United_FC.svg",
                           "https://upload.wikimedia.org/wikipedia/en/4/43/Wigan_Athletic.svg",
                           "https://upload.wikimedia.org/wikipedia/en/b/bc/Wimbledon_fc.png",
                           "https://upload.wikimedia.org/wikipedia/en/f/fc/Wolverhampton_Wanderers.svg"),stringsAsFactors = FALSE)

laliga_crests <-  data.frame(team=c("Ath Bilbao","Ath Madrid","Barcelona","Betis","Celta","Espanol",
                                    "Getafe","Granada","La Coruna","Levante","Malaga","Mallorca",
                                    "Osasuna","Real Madrid","Sevilla","Sociedad","Valencia","Valladolid",
                                    "Vallecano","Zaragoza"),
                             image=c("https://upload.wikimedia.org/wikipedia/en/9/98/Club_Athletic_Bilbao_logo.svg",
                                     "https://upload.wikimedia.org/wikipedia/en/c/c1/Atletico_Madrid_logo.svg",
                                     "https://upload.wikimedia.org/wikipedia/en/4/47/FC_Barcelona_%28crest%29.svg",
                                     "https://upload.wikimedia.org/wikipedia/en/1/13/Real_betis_logo.svg",
                                     "https://upload.wikimedia.org/wikipedia/en/1/12/RC_Celta_de_Vigo_logo.svg",
                                     "https://upload.wikimedia.org/wikipedia/en/d/d6/Rcd_espanyol_logo.svg",
                                     "https://upload.wikimedia.org/wikipedia/en/7/7f/Getafe_logo.png",
                                     "https://upload.wikimedia.org/wikipedia/en/b/ba/Granada_CF_logotipo.svg",
                                     "https://upload.wikimedia.org/wikipedia/en/4/4e/RC_Deportivo_La_Coru%C3%B1a_logo.svg",
                                     "https://upload.wikimedia.org/wikipedia/en/7/7b/Levante_Uni%C3%B3n_Deportiva%2C_S.A.D._logo.svg",
                                     "https://upload.wikimedia.org/wikipedia/en/c/c3/M%C3%A1laga_CF.png",
                                     "https://upload.wikimedia.org/wikipedia/en/e/e0/Rcd_mallorca.svg",
                                     "https://upload.wikimedia.org/wikipedia/en/d/db/Osasuna_logo.svg",
                                     "https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg",
                                     "https://upload.wikimedia.org/wikipedia/en/8/86/Sevilla_cf_200px.png",
                                     "https://upload.wikimedia.org/wikipedia/en/f/f1/Real_Sociedad_logo.svg",
                                     "https://upload.wikimedia.org/wikipedia/en/c/ce/Valenciacf.svg",
                                     "https://upload.wikimedia.org/wikipedia/en/6/6e/Real_Valladolid_Logo.svg",
                                     "https://upload.wikimedia.org/wikipedia/commons/1/17/Rayo_Vallecano_logo.png",
                                     "https://upload.wikimedia.org/wikipedia/en/1/17/Real_Zaragoza_svg_logo.svg"))


#loading the packages we'll need
require(RCurl) # import csv from URL
require(dplyr) # data manipulation/filtering
require(visNetwork) # producing interactive graphs
require(igraph) # to calculate graph properties
require(ggplot2) # vanilla graphs
require(purrr) # map lists to functions

options(stringsAsFactors = FALSE)
epl_1213 <- read.csv(text=getURL("http://www.football-data.co.uk/mmz4281/1213/E0.csv"), 
                     stringsAsFactors = FALSE)
head(epl_1213[,1:10])

# example of an undirected graph
nodes <- data.frame(id = LETTERS[1:4], 
                    label = LETTERS[1:4],         
                    title = paste0("<p>","This is a Node","<br>It wiggles</p>"),
                    shape= "icon",
                    icon = list(code = "f007", color="royalblue"))

edges <- data.frame(from = c("A","A","B","C"), 
                    to = c("B","C","C","D"),
                    length = 150,
                    color = list(color="lightgray")) %>%
  mutate(title = 
           paste0("<p>This is an edge<br><b>",from,"</b> is friends with <b>",to,"</b></p>"))

visNetwork(nodes, edges,main = "Facebook Friends Network (Undirected Graph)", width="800px", height="250px") %>%
  addFontAwesome() %>%  visLayout(randomSeed=151)

# example of a directed graph

nodes <- data.frame(id = LETTERS[1:4], 
                    label = LETTERS[1:4],         
                    title = paste0("<p>","This is a Node","<br>It wiggles</p>"),
                    shape= "icon",
                    icon = list(code = "f007", color="skyblue"))


edges <- data.frame(from = c("A","A","B","B","C","D"), 
                    to = c("B","C","A","C","D","C"),
                    length = 150,
                    color = list(color="lightgray")) %>%
  mutate(title = 
           paste0("<p>This is an edge<br><b>",to,"</b> follows <b>",from,"</b></p>"))

visNetwork(nodes, edges,main = "Twitter Follower Network (Directed Graph)", width="800px", height="250px") %>% 
  visEdges(arrows = 'from') %>% 
  addFontAwesome() %>%   visLayout(randomSeed=151)

epl_1213 <- epl_1213 %>% dplyr::select(HomeTeam, AwayTeam, FTHG, FTAG) %>% 
  dplyr::rename(team1=HomeTeam, team2= AwayTeam, team1FT = FTHG, team2FT = FTAG) %>%
  dplyr::filter(team1!="")

epl_1213 <- bind_rows(list(epl_1213 %>% 
                             dplyr::group_by(team1,team2) %>%
                             dplyr::summarize(points = sum(case_when(team1FT>team2FT~3,
                                                                     team1FT==team2FT~1,
                                                                     TRUE ~ 0))),
                           epl_1213 %>% dplyr::rename(team2=team1,team1=team2) %>%
                             dplyr::group_by(team1,team2) %>%
                             dplyr::summarize(points = sum(case_when(team2FT>team1FT~3,
                                                                     team2FT==team1FT~1,
                                                                     TRUE ~ 0))))) %>%
  dplyr::group_by(team1, team2) %>% dplyr::summarize(tot_points = sum(points)) %>% 
  dplyr::ungroup() %>% dplyr::arrange(team1,team2)

head(epl_1213)

nodes <- dplyr::group_by(epl_1213, team1) %>% 
  dplyr::summarize(value = sum(tot_points)) %>%
  dplyr::rename(id = team1) %>% 
  dplyr::inner_join(crests, by=c("id"= "team")) %>%
  dplyr::arrange(desc(value)) %>%
  dplyr::mutate(shape="image", label = "", 
                title = paste0("<p><b>",id,"</b><br>Points: ",
                               value,"<br>Position: ",row_number(),"</p>"))

head(nodes)

# construct edges
edge_list <- epl_1213 %>% dplyr::filter(as.character(team1)<as.character(team2)) %>% 
  dplyr::filter(!tot_points %in% c(0,6)) %>%
  dplyr::rename(from=team1,to=team2,value=tot_points) %>% dplyr::select(from, to)

head(edge_list)

# plot network graph
visNetwork(nodes,edge_list,main = "EPL 2012-13 Season",width="800px") %>%
  visEdges(color = list(color="gray",opacity=0.25)) %>%
  visOptions( highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  visEvents(stabilizationIterationsDone="function () {this.setOptions( { physics: false } );}") %>%
  visLayout(randomSeed=91)

epl_igraph_1213 <- graph_from_data_frame(d=edge_list, vertices=nodes, directed=F)
degs <- rep(0, nrow(nodes)+1)
deg_dist <- degree_distribution(epl_igraph_1213, cumulative=T, mode="all")
degs[1:length(deg_dist)] <-  deg_dist
plot( x=0:(length(degs)-1), y=1-degs, pch=19, cex=1.2, col="orange", 
      xlab="Degree", ylab="Cumulative Frequency", main= " Cumulative Frequency of EPL 2012-13 Degrees")

# pageRank
data.frame(pageRank = 
             round(page_rank(epl_igraph_1213)$vector[order(-page_rank(epl_igraph_1213)$vector)],4))

# betweeness
data.frame(betweeness = 
             round(betweenness(epl_igraph_1213)[order(-betweenness(epl_igraph_1213))],2))

### Wrapping previous code in loop to get historical competitiveness

epl_urls <- c("http://www.football-data.co.uk/mmz4281/9596/E0.csv",
              "http://www.football-data.co.uk/mmz4281/9697/E0.csv",
              "http://www.football-data.co.uk/mmz4281/9798/E0.csv",
              "http://www.football-data.co.uk/mmz4281/9899/E0.csv",
              "http://www.football-data.co.uk/mmz4281/9900/E0.csv",
              "http://www.football-data.co.uk/mmz4281/0001/E0.csv",
              "http://www.football-data.co.uk/mmz4281/0102/E0.csv",
              "http://www.football-data.co.uk/mmz4281/0203/E0.csv",
              "http://www.football-data.co.uk/mmz4281/0304/E0.csv",
              "http://www.football-data.co.uk/mmz4281/0405/E0.csv",
              "http://www.football-data.co.uk/mmz4281/0506/E0.csv",
              "http://www.football-data.co.uk/mmz4281/0607/E0.csv",
              "http://www.football-data.co.uk/mmz4281/0708/E0.csv",
              "http://www.football-data.co.uk/mmz4281/0809/E0.csv",
              "http://www.football-data.co.uk/mmz4281/0910/E0.csv",
              "http://www.football-data.co.uk/mmz4281/1011/E0.csv",
              "http://www.football-data.co.uk/mmz4281/1112/E0.csv",
              "http://www.football-data.co.uk/mmz4281/1213/E0.csv",
              "http://www.football-data.co.uk/mmz4281/1314/E0.csv",
              "http://www.football-data.co.uk/mmz4281/1415/E0.csv",
              "http://www.football-data.co.uk/mmz4281/1516/E0.csv")
epl_data  <- lapply(1:length(epl_urls),function(k){
  epl <- read.csv(text = getURL(epl_urls[k]), stringsAsFactors = FALSE) %>% 
    filter(HomeTeam !="") %>% select(HomeTeam, AwayTeam, FTHG, FTAG) %>% 
    dplyr::rename(team1=HomeTeam, team2= AwayTeam, team1FT = FTHG, team2FT = FTAG) 
  
  epl<-  bind_rows(list(epl %>%
                          dplyr::group_by(team1,team2) %>% 
                          dplyr::summarize(points = sum(case_when(team1FT>team2FT~3,
                                                                  team1FT==team2FT~1,
                                                                  TRUE ~ 0))),
                        epl %>% dplyr::rename(team2=team1,team1=team2) %>% 
                          dplyr::group_by(team1,team2) %>% 
                          dplyr::summarize(points = sum(case_when(team2FT>team1FT~3,
                                                                  team2FT==team1FT~1,
                                                                  TRUE ~ 0))))) %>%
    dplyr::group_by(team1, team2) %>% dplyr::summarize(tot_points = sum(points)) %>% 
    dplyr::ungroup() %>% dplyr::arrange(team1,team2)
  
  nodes <- dplyr::group_by(epl, team1) %>% dplyr::summarize(value = sum(tot_points)) %>% 
    dplyr::rename(id = team1) %>% dplyr::inner_join(crests, by=c("id"= "team")) %>%
    dplyr::mutate(shape="image", label = "") %>% dplyr::arrange(desc(value))
  
  edge_list <- epl %>% dplyr::filter(as.character(team1)<as.character(team2)) %>% 
    dplyr::filter(!tot_points %in% c(0,6)) %>%
    dplyr::rename(from=team1,to=team2,value=tot_points) %>% dplyr::select(from, to)
  
  epl_igraph <- graph_from_data_frame(d=edge_list, vertices=nodes, directed=F) 

  
  eigen_epl_0001 = page_rank(epl_igraph)
  
  c(paste0(1995+k-1,"-",sprintf("%02d",(1995+k)%%100)),
    mean(degree(epl_igraph)),
    sd(nodes$value),
    names(which.max(page_rank(epl_igraph)$vector)))
})
epl_data <- as.data.frame(do.call(rbind, epl_data))
colnames(epl_data) <- c("Season", "meanDegree", "pointSD", "Most_Competitive")
epl_data$meanDegree=as.numeric(epl_data$meanDegree)
epl_data$pointSD=as.numeric(epl_data$pointSD)

epl_data

# correlation between the pointSD and meanDegree measures of competitiveness
cor(x = epl_data$pointSD, y = epl_data$meanDegree)

# plot historical competitiveness of EPL
ggplot(rbind(epl_data %>% dplyr::select(Season, meanDegree) %>% 
               dplyr::rename(value = meanDegree) %>% dplyr::mutate(measure="Mean Degree"),
             epl_data %>% dplyr::select(Season, pointSD) %>% 
               dplyr::rename(value = pointSD) %>% dplyr::mutate(measure="Point SD")), 
       aes(x=Season, y= value ,color = measure,group=measure)) + geom_line(size=1) +
  geom_point(size=2,color="black") + xlab("EPL Season") + ylab("Value") + 
  ggtitle("Historical Competitiveness of English Premier League") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# meanDegree linear model
summary(lm(meanDegree~Season,data=epl_data %>% dplyr::mutate(Season=1:nrow(epl_data))))

# pointSD linear model
summary(lm(pointSD~Season,data=epl_data %>% dplyr::mutate(Season=1:nrow(epl_data))))


#######################################################
######### La Liga #####################################

ll_1213 <- read.csv(text = getURL("http://www.football-data.co.uk/mmz4281/1213/SP1.csv"), 
                    stringsAsFactors = FALSE)
ll_1213 <- ll_1213 %>% dplyr::select(HomeTeam, AwayTeam, FTHG, FTAG) %>% 
  dplyr::rename(team1=HomeTeam, team2= AwayTeam, team1FT = FTHG, team2FT = FTAG) %>%
  dplyr::filter(team1!="")

ll_1213 <- bind_rows(list(ll_1213 %>% 
                            dplyr::group_by(team1,team2) %>%
                            dplyr::summarize(points = sum(case_when(team1FT>team2FT~3,
                                                                    team1FT==team2FT~1,
                                                                    TRUE ~ 0))),
                          ll_1213 %>% dplyr::rename(team2=team1,team1=team2) %>%
                            dplyr::group_by(team1,team2) %>%
                            dplyr::summarize(points = sum(case_when(team2FT>team1FT~3,
                                                                    team2FT==team1FT~1,
                                                                    TRUE ~ 0))))) %>%
  dplyr::group_by(team1, team2) %>% dplyr::summarize(tot_points = sum(points)) %>% 
  dplyr::ungroup() %>% dplyr::arrange(team1,team2)

nodes <- dplyr::group_by(ll_1213, team1) %>% 
  dplyr::summarize(value = sum(tot_points)) %>%
  dplyr::rename(id = team1) %>% 
  dplyr::inner_join(laliga_crests, by=c("id"= "team")) %>%
  dplyr::arrange(desc(value)) %>%
  dplyr::mutate(shape="image", label = "", 
                title = paste0("<p><b>",id,"</b><br>Points: ",
                               value,"<br>Position: ",row_number(),"</p>"))


# construct edges
edge_list <- ll_1213 %>% dplyr::filter(as.character(team1)<as.character(team2)) %>% 
  dplyr::filter(!tot_points %in% c(0,6)) %>%
  dplyr::rename(from=team1,to=team2,value=tot_points) %>% dplyr::select(from, to)

visNetwork(nodes,edge_list,main = "La Liga 2012-13 Season",width="800px") %>%
  visEdges(color = list(color="gray", opacity=0.25)) %>%
  visOptions( highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  visEvents(stabilizationIterationsDone="function () {this.setOptions( { physics: false } );}") %>%
  visLayout(randomSeed=303)


ll_urls <- gsub("E0","SP1",epl_urls)
historical_league_data <- function(urls){
  league_data  <- lapply(1:length(urls),function(k){
    league <- read.csv(text = getURL(urls[k]), stringsAsFactors = FALSE) %>% 
      filter(HomeTeam !="") %>% select(HomeTeam, AwayTeam, FTHG, FTAG) %>% 
      dplyr::rename(team1=HomeTeam, team2= AwayTeam, team1FT = FTHG, team2FT = FTAG) 
    
    league<-  bind_rows(list(league %>%
                               dplyr::group_by(team1,team2) %>% 
                               dplyr::summarize(points = sum(case_when(team1FT>team2FT~3,
                                                                       team1FT==team2FT~1,
                                                                       TRUE ~ 0))),
                             league %>% dplyr::rename(team2=team1,team1=team2) %>% 
                               dplyr::group_by(team1,team2) %>% 
                               dplyr::summarize(points = sum(case_when(team2FT>team1FT~3,
                                                                       team2FT==team1FT~1,
                                                                       TRUE ~ 0))))) %>%
      dplyr::group_by(team1, team2) %>% dplyr::summarize(tot_points = sum(points)) %>% 
      dplyr::ungroup() %>% dplyr::arrange(team1,team2)
    
    nodes <- dplyr::group_by(league, team1) %>% dplyr::summarize(value = sum(tot_points)) %>% 
      dplyr::rename(id = team1) %>% dplyr::arrange(desc(value))
    
    edge_list <- league %>% dplyr::filter(as.character(team1)<as.character(team2)) %>% 
      dplyr::filter(!tot_points %in% c(0,6)) %>%
      dplyr::rename(from=team1,to=team2,value=tot_points) %>% dplyr::select(from, to)
    
    
    league_igraph <- graph_from_data_frame(d=edge_list, vertices=nodes, directed=F) 
    
    
    eigen_league_0001 = page_rank(league_igraph)
    
    
    c(paste0(1995+k-1,"-",sprintf("%02d",(1995+k)%%100)),
      mean(degree(league_igraph)),
      sd(nodes$value),
      names(which.max(page_rank(league_igraph)$vector)))
  })
  league_data <- as.data.frame(do.call(rbind, league_data))
  colnames(league_data) <- c("Season", "meanDegree", "pointSD", "Most_Competitive")
  league_data$meanDegree <- as.numeric(league_data$meanDegree)
  league_data$pointSD <- as.numeric(league_data$pointSD)
  league_data
}
ll_data <- historical_league_data(ll_urls)
ll_data <- ll_data[3:nrow(ll_data),]
ll_data
ggplot(rbind(ll_data %>% dplyr::select(Season, meanDegree) %>% 
               dplyr::rename(value = meanDegree) %>% dplyr::mutate(measure="Value"),
             ll_data %>% dplyr::select(Season, pointSD) %>% 
               dplyr::rename(value = pointSD) %>% dplyr::mutate(measure="Point SD")), 
       aes(x=Season, y= value ,color = measure,group=measure)) + geom_line(size=1) +
  geom_point(size=2,color="black") + xlab("La Liga Season") + ylab("Value") + 
  ggtitle("Historical Competitiveness of La Liga") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#######################################################
#######################################################

# meanDegree linear model
summary(lm(meanDegree~Season,data=ll_data %>% dplyr::mutate(Season=0:(nrow(ll_data)-1))))

# pointSD linear model
summary(lm(pointSD~Season,data=ll_data %>% dplyr::mutate(Season=0:(nrow(ll_data)-1))))


#######################################################
############## Europe's Top 5 Leagues #################

seriea_urls <- gsub("E0","I1",epl_urls)
bundes_urls <- gsub("E0","D1",epl_urls)
ligue1_urls <- gsub("E0","F1",epl_urls)
seriea_data <- historical_league_data(seriea_urls)
# only want the Serie A seasons with 20 teams
seriea_data <- seriea_data[10:nrow(seriea_data),]
bundes_data <- historical_league_data(bundes_urls)
ligue1_data <- historical_league_data(ligue1_urls)

all_leagues <- bind_rows(list(dplyr::mutate(epl_data, league="EPL"),
                              dplyr::mutate(ll_data, league="La Liga"),
                              dplyr::mutate(seriea_data, league="Serie A"),
                              dplyr::mutate(bundes_data, league="Bundesliga"),
                              dplyr::mutate(ligue1_data, league="Ligue Un")))

ggplot(all_leagues,
       aes(x=Season, y= pointSD ,color = league,group=league)) + geom_line(size=1) +
  geom_point(size=2,color="black") + xlab("Season") + ylab("pointSD") + 
  ggtitle("Historical Competitiveness Europe's Top 5 Leagues") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# coefficients of linear models
all_leagues %>%  dplyr::group_by(league) %>% dplyr::mutate(Season = 0:(n()-1)) %>% 
  split(.$league) %>% purrr::map(~ lm(pointSD ~ Season, data=.)) %>%
  purrr::map(summary) %>%  purrr::map("coefficients")

# R-squared values for respective linear models
all_leagues %>%  dplyr::group_by(league) %>% dplyr::mutate(Season = 0:(n()-1)) %>% 
  split(.$league) %>% purrr::map(~ lm(pointSD ~ Season, data=.)) %>%
  purrr::map(summary) %>% purrr::map("r.squared")